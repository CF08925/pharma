<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{dashboard/layout}">
<head>
  <title>Receipt Management</title>
</head>

<body>
<section layout:fragment="dashboard">

  <!-- Page Heading -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Receipt Management</h1>
  </div>

  <!-- Content Row - Statistics Cards -->
  <div class="row">
    <!-- Pending Receipts Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending Receipts</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${pendingCount}">18</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clock fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Approved Receipts Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Approved Receipts</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${approvedCount}">25</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Processing Receipts Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Processing</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${processingCount}">5</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-cog fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rejected Receipts Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-danger shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Rejected</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${rejectedCount}">3</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-times-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Filters</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <form method="get" th:action="@{/admin/receipts}">
            <div class="form-group">
              <label for="statusFilter">Filter by Status:</label>
              <select class="form-control" id="statusFilter" name="status" th:value="${selectedStatus}">
                <option value="">All Statuses</option>
                <option th:each="status : ${statuses}"
                        th:value="${status.name()}"
                        th:text="${status.getDisplayName()}"
                        th:selected="${status.name() == selectedStatus}">Status</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
          </form>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label>&nbsp;</label>
            <div>
              <a href="/admin/receipts" class="btn btn-secondary btn-sm">Clear Filters</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${success}"></span>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <!-- Receipts Table -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Receipt List</h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
          <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Phone</th>
            <th>Amount</th>
            <th>Images</th>
            <th>Upload Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tfoot>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Phone</th>
            <th>Amount</th>
            <th>Images</th>
            <th>Upload Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
          </tfoot>
          <tbody>
          <tr th:each="receipt : ${receipts}">
            <td th:text="${receipt.id}">1</td>
            <td th:text="${receipt.getFullName()}">John Doe</td>
            <td th:text="${receipt.getFullPhoneNumber()}">0501234567</td>
            <td th:text="${receipt.getFormattedAmount()}">19.99 AZN</td>
            <td>
              <span class="badge badge-info" th:text="${receipt.getImageCount()} + ' images'">3 images</span>
            </td>
            <td th:text="${receipt.getFormattedUploadDate()}">22.05.2025 14:30</td>
            <td>
              <!-- Fixed Status Badges - Using separate conditional spans -->
              <span th:if="${receipt.status.name() == 'PENDING'}" class="badge badge-warning" th:text="${receipt.getStatusDisplayName()}">Pending</span>
              <span th:if="${receipt.status.name() == 'APPROVED'}" class="badge badge-success" th:text="${receipt.getStatusDisplayName()}">Approved</span>
              <span th:if="${receipt.status.name() == 'PROCESSING'}" class="badge badge-info" th:text="${receipt.getStatusDisplayName()}">Processing</span>
              <span th:if="${receipt.status.name() == 'REJECTED'}" class="badge badge-danger" th:text="${receipt.getStatusDisplayName()}">Rejected</span>
            </td>
            <td>
              <a th:href="@{'/admin/receipts/' + ${receipt.id}}" class="btn btn-info btn-sm">
                <i class="fas fa-eye"></i> View
              </a>

              <!-- Quick Status Update Buttons -->
              <div class="btn-group">
                <button type="button" class="btn btn-secondary btn-sm dropdown-toggle"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Status
                </button>
                <div class="dropdown-menu">
                  <form th:action="@{'/admin/receipts/' + ${receipt.id} + '/status'}" method="post" style="display: inline;">
                    <input type="hidden" name="status" value="PENDING">
                    <button class="dropdown-item" type="submit"
                            th:disabled="${receipt.status.name() == 'PENDING'}">
                      <i class="fas fa-clock text-warning"></i> Pending
                    </button>
                  </form>
                  <form th:action="@{'/admin/receipts/' + ${receipt.id} + '/status'}" method="post" style="display: inline;">
                    <input type="hidden" name="status" value="PROCESSING">
                    <button class="dropdown-item" type="submit"
                            th:disabled="${receipt.status.name() == 'PROCESSING'}">
                      <i class="fas fa-cog text-info"></i> Processing
                    </button>
                  </form>
                  <form th:action="@{'/admin/receipts/' + ${receipt.id} + '/status'}" method="post" style="display: inline;">
                    <input type="hidden" name="status" value="APPROVED">
                    <button class="dropdown-item" type="submit"
                            th:disabled="${receipt.status.name() == 'APPROVED'}">
                      <i class="fas fa-check text-success"></i> Approve
                    </button>
                  </form>
                  <form th:action="@{'/admin/receipts/' + ${receipt.id} + '/status'}" method="post" style="display: inline;">
                    <input type="hidden" name="status" value="REJECTED">
                    <button class="dropdown-item" type="submit"
                            th:disabled="${receipt.status.name() == 'REJECTED'}">
                      <i class="fas fa-times text-danger"></i> Reject
                    </button>
                  </form>
                </div>
              </div>

              <!-- Delete Button -->
              <button type="button" class="btn btn-danger btn-sm" data-toggle="modal"
                      th:attr="data-target='#deleteModal' + ${receipt.id}">
                <i class="fas fa-trash"></i> Delete
              </button>

              <!-- Delete Modal -->
              <div class="modal fade" th:id="'deleteModal' + ${receipt.id}" tabindex="-1"
                   role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Confirm Delete</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <p>Are you sure you want to delete this receipt?</p>
                      <p><strong>Customer:</strong> <span th:text="${receipt.getFullName()}"></span></p>
                      <p><strong>Amount:</strong> <span th:text="${receipt.getFormattedAmount()}"></span></p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <form th:action="@{'/admin/receipts/' + ${receipt.id} + '/delete'}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete Receipt</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</section>

</body>
</html>